
import streamlit as st
import google.generativeai as genai
from slack_sdk import WebClient
import numpy as np

# --- 1. ‡∏™‡πà‡∏ß‡∏ô‡∏î‡∏∂‡∏á‡∏Å‡∏∏‡∏ç‡πÅ‡∏à (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å Streamlit Secrets ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ) ---
try:
    # ‡∏î‡∏∂‡∏á API Key ‡∏à‡∏≤‡∏Å Google AI Studio (‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ "‡∏â‡∏±‡∏ô" ‡∏ó‡∏µ‡πà‡∏°‡∏µ 4 ‡∏Ñ‡∏µ‡∏¢‡πå)
    GEMINI_KEY = st.secrets["GEMINI_API_KEY"]
    
    # ‡∏î‡∏∂‡∏á Slack Token (‡∏£‡∏´‡∏±‡∏™ Xoxe/xoxb ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡πÑ‡∏ß‡πâ)
    SLACK_TOKEN = st.secrets["SLACK_TOKEN"]
    
    # ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏∏‡∏ç‡πÅ‡∏à
    genai.configure(api_key=GEMINI_KEY)
    model = genai.GenerativeModel('gemini-1.5-flash')
    slack_client = WebClient(token=SLACK_TOKEN)
except Exception as e:
    st.error("‚ùå ‡∏´‡∏≤ API Key ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Secrets ‡∏ß‡πà‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠ GEMINI_API_KEY ‡πÅ‡∏•‡∏∞ SLACK_TOKEN ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏´‡∏°")
    st.stop()

# --- 2. ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡πÅ‡∏≠‡∏õ (UI) ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏û‡∏•‡∏á ---
st.set_page_config(page_title="RBF AI Composer", layout="wide")
st.title("üéµ ‡πÅ‡∏≠‡∏õ‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏û‡∏•‡∏á AI ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î (Gemini + Slack)")

st.sidebar.header("‚öôÔ∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö")
st.sidebar.info("‡∏Å‡∏∏‡∏ç‡πÅ‡∏à Google: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‚úÖ\n\n‡∏Å‡∏∏‡∏ç‡πÅ‡∏à Slack: ‡∏£‡∏∞‡∏î‡∏±‡∏ö 4 (100+ ‡∏ï‡πà‡∏≠‡∏ô‡∏≤‡∏ó‡∏µ) ‚úÖ")

# ‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
topic = st.text_input("‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£", "‡πÄ‡∏û‡∏•‡∏á‡∏£‡∏±‡∏Å‡∏ü‡∏µ‡∏•‡πÄ‡∏®‡∏£‡πâ‡∏≤‡πÜ ‡∏ï‡∏≠‡∏ô‡∏ù‡∏ô‡∏ï‡∏Å")

if st.button("üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏û‡∏•‡∏á‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ Slack", type="primary"):
    with st.spinner("AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏û‡∏•‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏∞‡∏ö‡∏ö RBF..."):
        try:
            # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÉ‡∏´‡πâ Gemini ‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≠‡∏£‡πå‡∏î
            prompt = f"‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏Å‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏û‡∏•‡∏á‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û ‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≠‡∏£‡πå‡∏î‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: {topic}"
            response = model.generate_content(prompt)
            lyrics = response.text
            
            # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏≠‡∏õ
            st.subheader("üìù ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≠‡∏£‡πå‡∏î‡∏à‡∏≤‡∏Å AI")
            st.markdown(lyrics)
            
            # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á (RBF Audio Synthesis)
            st.subheader("üîä ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (Simulated)")
            sr = 44100
            audio_wave = np.random.uniform(-0.1, 0.1, sr * 3) # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏à‡∏≥‡∏•‡∏≠‡∏á 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            st.audio(audio_wave, format='audio/wav', sample_rate=sr)
            
            # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Slack (‡πÉ‡∏ä‡πâ Token ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
            slack_client.chat_postMessage(
                channel="general", 
                text=f"üé∂ *‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏û‡∏•‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!* \n*‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠:* {topic}\n\n{lyrics}"
            )
            st.success("‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Slack ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! (‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö 4)")

        except Exception as e:
            st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {e}")

# --- 3. ‡∏™‡πà‡∏ß‡∏ô Log ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô) ---
with st.expander("üõ†Ô∏è ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• (Engine Log)"):
    st.write("1. ‡∏£‡∏±‡∏ö Input ‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á API Keys ‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢")
    st.write("2. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Gemini API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏ä‡∏¥‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå")
    st.write("3. ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô Symbolic Sequence ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á")
    st.write("4. ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ú‡πà‡∏≤‡∏ô Slack API (Rate Limit Level 4)")
