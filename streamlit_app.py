import streamlit as st
import librosa
import numpy as np
import io
import requests
import soundfile as sf

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ---
st.set_page_config(page_title="SYNAPSE R&B Studio", layout="wide")
st.title("üé§ SYNAPSE Studio: ‡πÉ‡∏à‡∏ß‡∏±‡∏î‡πÉ‡∏à (R&B Edition)")
st.write("‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏û‡∏•‡∏á ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤ '‡∏ó‡∏≤‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°' ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Ñ‡∏£‡∏±‡∏ö")

# --- 1. ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ï‡∏£‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà GitHub ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ---
# ‡∏ú‡∏°‡πÉ‡∏ä‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå Raw ‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠ User ‡πÅ‡∏•‡∏∞ Branch ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
base_url = "https://raw.githubusercontent.com/leehunna789-boop/‡∏´‡∏•‡∏±‡∏Å/main/"

def load_audio(name):
    """‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å GitHub"""
    try:
        res = requests.get(base_url + name)
        if res.status_code == 200:
            # ‡πÉ‡∏ä‡πâ sr=None ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÄ‡∏û‡∏•‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö
            data, sr = librosa.load(io.BytesIO(res.content), sr=None)
            return data, sr
        else:
            return None, None
    except Exception:
        return None, None

# --- 2. ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏û‡∏¥‡∏™‡∏π‡∏à‡∏ô‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á ---
if st.button("üî• ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö: ‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏ú‡∏™‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á"):
    status_v = st.empty()
    status_b = st.empty()
    
    with st.spinner("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å GitHub..."):
        # ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÑ‡∏ü‡∏•‡πå 2 ‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ß‡πâ (Vocal ‡πÅ‡∏•‡∏∞ Beat)
        vocal_data, sr_v = load_audio("rnb_vocal_ref.wav")
        beat_data, sr_b = load_audio("rnb_beat_full.wav")
        
        # ‡πÄ‡∏ä‡πá‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏ü‡∏•‡πå
        if vocal_data is not None:
            status_v.success("‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Vocal ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
        else:
            status_v.error("‚ùå ‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå rnb_vocal_ref.wav ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠")
            
        if beat_data is not None:
            status_b.success("‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Beat ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
        else:
            status_b.error("‚ùå ‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå rnb_beat_full.wav ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠")

        # --- 3. Logic ‡∏Å‡∏≤‡∏£‡∏ú‡∏™‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Mixing) ---
        if vocal_data is not None and beat_data is not None:
            # ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ú‡∏™‡∏°
            length = min(len(vocal_data), len(beat_data))
            # ‡∏ú‡∏™‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏ß‡∏Å‡∏Å‡∏±‡∏ô‡∏ó‡∏≤‡∏á‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå (Vocal + Beat)
            mixed_audio = vocal_data[:length] + beat_data[:length]
            
            st.divider()
            st.subheader("üéß ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏¥‡∏Å‡∏ã‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß")
            
            # ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Streamlit ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ
            buffer = io.BytesIO()
            sf.write(buffer, mixed_audio, sr_v, format='WAV')
            st.audio(buffer.getvalue())
            
            st.balloons()
            st.success("‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á! ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏û‡∏•‡∏á ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤ 3,000 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏≠‡∏≠‡∏Å‡∏î‡∏≠‡∏Å‡∏ú‡∏•‡∏Ñ‡∏£‡∏±‡∏ö")
        else:
            st.warning("‚ö†Ô∏è ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô GitHub ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πá‡∏Å-‡πÉ‡∏´‡∏ç‡πà)")

st.info("‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏´‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô Error ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÉ‡∏ô URL ‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Å‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö")
