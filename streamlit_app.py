import streamlit as st
import numpy as np
import io
import scipy.io.wavfile as wavfile

st.title("üéß ‡πÄ‡∏û‡∏•‡∏á‡πÅ‡∏£‡πá‡∏õ:‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏∑‡πâ‡∏á‡πÜ‡πÑ‡∏°‡∏≤‡πâ‡∏à‡πá‡∏ö‡∏ï‡∏±‡∏ß ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏á (Sequencer)")
st.caption("‡πÅ‡∏Å‡πâ Error: NameError ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢")

# --- 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡πà‡∏≠‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ!) ---
st.write("üëá ‡πÉ‡∏™‡πà‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö")
col1, col2, col3 = st.columns(3)

with col1:
    # ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô (v1)
    
    v1 = st.file_uploader("‡∏ó‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1", type=["wav"], key="v1")
# 1. ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Angular CLI (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
npm install -g @angular/cli

# 2. ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Library ‡∏ó‡∏µ‡πà‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏£‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ (Firebase)
npm install firebase @angular/fire

# 3. ‡∏™‡∏±‡πà‡∏á‡∏£‡∏±‡∏ô‡πÅ‡∏≠‡∏õ
ng serve --open

with col2:
    v2 = st.file_uploader("‡∏ó‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2", type=["wav"], key="v2")

with col3:
    v3 = st.file_uploader("‡∏ó‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3", type=["wav"], key="v3")

# --- 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå WAV (‡πÉ‡∏ä‡πâ scipy ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á librosa) ---
def load_wav(uploaded_file):
    if uploaded_file is not None:
        # ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå
        sr, data = wavfile.read(uploaded_file)
        # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Stereo (2 channel) ‡πÉ‡∏´‡πâ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô Mono
        if len(data.shape) > 1:
            data = data.mean(axis=1)
        # ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° (-1 ‡∏ñ‡∏∂‡∏á 1) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏á‡πà‡∏≤‡∏¢
        return data / np.max(np.abs(data)), sr
    return None, None

# --- 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÉ‡∏™‡πà‡∏Ñ‡∏£‡∏ö‡πÑ‡∏´‡∏° (‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏´‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏û‡∏µ‡πà Error ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏µ‡πâ) ---
# ‡∏ú‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡πà‡∏≤ v1, v2, v3 ‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏°
if v1 and v2 and v3:
    st.success("‚úÖ ‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏•‡∏¢")
    
    if st.button("üöÄ ‡∏£‡∏ß‡∏°‡∏£‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏•‡∏á"):
        # ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á
        d1, sr1 = load_wav(v1)
        d2, sr2 = load_wav(v2)
        d3, sr3 = load_wav(v3)
        
        # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Sample Rate ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏´‡∏° (‡∏Å‡∏±‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô)
        if sr1 == sr2 == sr3:
            # --- ‡∏ï‡πà‡∏≠‡∏ï‡∏π‡∏î‡∏Å‡∏±‡∏ô (Concatenate) ---
            full_song = np.concatenate([d1, d2, d3])
            
            st.write("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...")
            
            # ‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á
            virtual_file = io.BytesIO()
            wavfile.write(virtual_file, sr1, (full_song * 32767).astype(np.int16))
            
            # ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏•‡∏á
            st.audio(virtual_file, format='audio/wav')
        else:
            st.error("‚ö†Ô∏è ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á Sample Rate ‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 44100 ‡∏Å‡∏±‡∏ö 48000) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏î‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö")

else:
    # ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‡∏°‡∏±‡∏ô‡∏à‡∏∞‡∏ö‡∏≠‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    st.info("üëà ‡∏û‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡∏ö ‡πÉ‡∏™‡πà‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 3 ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô")
